<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#0f172a">
  <link rel="apple-touch-icon" href="https://api.iconify.design/lucide:camera.svg?color=%230f172a">
  <link rel="manifest" href='data:application/manifest+json;utf-8,{"name":"ScanMaster","short_name":"ScanMaster","start_url":".","display":"standalone","background_color":"#f8fafc","theme_color":"#0f172a","icons":[{"src":"https://api.iconify.design/lucide:camera.svg","sizes":"192x192","type":"image/svg+xml"}]}'>
  <!-- Load Vue 3, Tailwind, and JSQR -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  
  <style>
    [v-cloak] { display: none; }
    
    /* Dedicated Print CSS for perfectly sizing the QR cards to exactly half an A4 page */
    @media print {
      body * { visibility: hidden; }
      #print-area, #print-area * { visibility: visible; }
      #print-area { position: absolute; left: 0; top: 0; width: 100%; display: block !important; }
      
      .qr-card {
        width: 100%;
        height: 148mm; /* Exactly half the height of A4 portrait */
        page-break-inside: avoid;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        border-bottom: 2px dashed #94a3b8;
        position: relative;
        box-sizing: border-box;
      }
      .qr-card:nth-child(even) { page-break-after: always; border-bottom: none; }
      
      .qr-wrapper { position: relative; width: 300px; height: 300px; margin-top: 20px;}
      .qr-image { width: 100%; height: 100%; image-rendering: pixelated; }
      
      .letter { position: absolute; font-size: 18pt; font-weight: bold; font-family: sans-serif; }
      .letter-A { top: -35px; left: 50%; transform: translateX(-50%); }
      .letter-B { right: -35px; top: 50%; transform: translateY(-50%) rotate(90deg); }
      .letter-C { bottom: -35px; left: 50%; transform: translateX(-50%) rotate(180deg); }
      .letter-D { left: -35px; top: 50%; transform: translateY(-50%) rotate(-90deg); }
    }
  </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans h-screen">
  <div id="app" v-cloak class="flex h-full print:block">
    
    <!-- Login/Register Screen (Main Entry Point) -->
    <div v-if="!isLoggedIn" class="absolute inset-0 bg-slate-900 flex items-center justify-center z-50 text-white p-6">
       <div class="bg-slate-800 p-8 rounded-xl shadow-2xl max-w-sm w-full border border-slate-700">
          <div class="flex justify-center mb-6">
            <div class="w-16 h-16 bg-blue-600 rounded-full flex items-center justify-center text-3xl shadow-lg shadow-blue-500/50">üì∏</div>
          </div>
          <h1 class="text-2xl font-bold text-center mb-2">Welcome to ScanMaster</h1>
          <p class="text-slate-400 text-center mb-6 text-sm">{{ authMode === 'login' ? 'Login to your account' : 'Create a new account' }}</p>
          
          <input v-model="authUser" type="text" placeholder="Username" class="w-full bg-slate-900 border border-slate-600 rounded px-4 py-3 mb-4 text-white outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition">
          <input v-model="authPass" type="password" placeholder="Password" class="w-full bg-slate-900 border border-slate-600 rounded px-4 py-3 mb-6 text-white outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition" @keyup.enter="authenticate">
          
          <div v-if="authError" class="text-red-400 text-sm mb-4 text-center font-medium p-3 bg-red-900/30 rounded border border-red-800/50 whitespace-pre-wrap">{{ authError }}</div>
          
          <button @click="authenticate" :disabled="isLoading" class="w-full bg-blue-600 text-white font-bold py-3 rounded hover:bg-blue-500 transition shadow-lg mb-4 flex justify-center items-center">
             <span v-if="!isLoading">{{ authMode === 'login' ? 'Login' : 'Register' }}</span>
             <span v-else class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></span>
          </button>
          
          <div class="text-center text-sm text-slate-400 cursor-pointer hover:text-white transition" @click="toggleAuthMode">
             {{ authMode === 'login' ? "Don't have an account? Register" : 'Already have an account? Login' }}
          </div>
       </div>
    </div>

    <!-- Sidebar -->
    <div v-if="isLoggedIn" class="w-64 bg-slate-900 text-slate-300 flex-col shadow-xl z-10 hidden md:flex print:hidden">
      <div class="p-6 text-white font-bold text-2xl tracking-wider flex items-center gap-2 border-b border-slate-800">
        ScanMaster
      </div>
      <nav class="flex-1 py-4">
        <button @click="activeTab = 'classes'" :class="['w-full text-left px-6 py-4 font-medium transition-colors border-l-4', activeTab === 'classes' ? 'bg-blue-600 text-white border-blue-400' : 'hover:bg-slate-800 border-transparent']">Sections & Students</button>
        <button @click="activeTab = 'quizzes'" :class="['w-full text-left px-6 py-4 font-medium transition-colors border-l-4', activeTab === 'quizzes' ? 'bg-blue-600 text-white border-blue-400' : 'hover:bg-slate-800 border-transparent']">Quizzes & Keys</button>
        <button @click="activeTab = 'scanner'" :class="['w-full text-left px-6 py-4 font-medium transition-colors border-l-4', activeTab === 'scanner' ? 'bg-blue-600 text-white border-blue-400' : 'hover:bg-slate-800 border-transparent']">Live Scanner</button>
        <button @click="activeTab = 'analytics'" :class="['w-full text-left px-6 py-4 font-medium transition-colors border-l-4', activeTab === 'analytics' ? 'bg-blue-600 text-white border-blue-400' : 'hover:bg-slate-800 border-transparent']">Analytics</button>
      </nav>
      <div class="p-4 border-t border-slate-800">
         <div class="text-sm font-bold text-white mb-2 flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-green-500"></span> {{ authUser }}</div>
         <button @click="logout" class="text-xs text-slate-400 hover:text-white font-medium w-full text-left transition">Sign Out</button>
      </div>
    </div>

    <!-- Mobile Topbar -->
    <div v-if="isLoggedIn" class="md:hidden fixed top-0 left-0 right-0 bg-slate-900 text-white p-4 flex justify-between items-center z-20 print:hidden shadow-md">
      <div class="font-bold text-lg">ScanMaster</div>
      <div class="flex items-center gap-3">
        <select v-model="activeTab" class="bg-slate-800 border-none outline-none text-sm p-2 rounded text-white">
          <option value="classes">Sections</option>
          <option value="quizzes">Quizzes</option>
          <option value="scanner">Scanner</option>
          <option value="analytics">Analytics</option>
        </select>
        <button @click="logout" class="text-xl">üö™</button>
      </div>
    </div>

    <!-- Main Content -->
    <div v-if="isLoggedIn" class="flex-1 overflow-auto p-4 md:p-8 pt-20 md:pt-8 relative print:p-0">
      
      <div v-if="isLoading" class="absolute inset-0 flex items-center justify-center bg-slate-50/80 z-50 print:hidden backdrop-blur-sm">
        <div class="flex flex-col items-center gap-4 bg-white p-6 rounded-xl shadow-lg border">
           <div class="w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
           <div class="font-bold text-slate-600">Syncing Cloud Database...</div>
        </div>
      </div>

      <!-- CLASSES TAB -->
      <div v-show="activeTab === 'classes'" class="flex flex-col md:flex-row gap-6 h-full print:hidden">
        
        <!-- Sections Panel -->
        <div class="w-full md:w-1/3 bg-white p-6 rounded-xl shadow-sm border border-slate-200 h-full overflow-y-auto flex flex-col">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold">Sections</h2>
            <button v-if="classQueue.length > 0" @click="saveClasses" :disabled="isSavingClasses" class="bg-green-600 text-white px-3 py-1 rounded text-sm font-bold shadow hover:bg-green-700 disabled:opacity-50 animate-pulse transition">
              {{ isSavingClasses ? 'Saving...' : 'üíæ Save Changes' }}
            </button>
          </div>
          <div class="flex gap-2 mb-6">
            <input v-model="newClassName" @keyup.enter="addClass" type="text" placeholder="New Section Name" class="flex-1 border rounded px-3 py-2 outline-none focus:ring-2 focus:ring-blue-500">
            <button @click="addClass" class="bg-blue-600 text-white px-4 py-2 rounded font-bold hover:bg-blue-700">+</button>
          </div>
          <ul class="space-y-2 flex-1">
            <li v-for="cls in classes" :key="cls.ClassID" @click="selectedClass = cls.ClassID" :class="['flex justify-between p-3 rounded cursor-pointer border transition', selectedClass === cls.ClassID ? 'bg-blue-50 border-blue-200' : 'hover:bg-slate-50 border-transparent']">
              <span>{{ cls.ClassName }}</span>
              <button @click.stop="deleteClass(cls.ClassID)" class="text-red-400 hover:text-red-600">Del</button>
            </li>
          </ul>
        </div>

        <!-- Students Panel -->
        <div class="w-full md:w-2/3 bg-white p-6 rounded-xl shadow-sm border border-slate-200 flex flex-col h-full">
          <div v-if="selectedClass" class="h-full flex flex-col">
             <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-6 gap-4">
               <h2 class="text-xl font-bold">Students</h2>
               <div class="flex items-center gap-2">
                 <button v-if="studentQueue.length > 0" @click="saveStudents" :disabled="isSavingStudents" class="bg-green-600 text-white px-3 py-2 rounded text-sm font-bold shadow hover:bg-green-700 disabled:opacity-50 animate-pulse transition">
                   {{ isSavingStudents ? 'Saving...' : 'üíæ Save Students' }}
                 </button>
                 <button @click="printQRs" class="bg-slate-800 text-white px-4 py-2 rounded text-sm hover:bg-slate-700 shadow">üñ®Ô∏è Print QR Cards</button>
               </div>
             </div>
             <div class="flex gap-2 mb-4">
                <input v-model="newStudentName" @keyup.enter="addStudent" placeholder="Student Name" class="flex-1 border rounded p-2 outline-none focus:ring-2 focus:ring-blue-500">
                <button @click="addStudent" class="bg-blue-600 text-white px-4 rounded font-bold hover:bg-blue-700">Add</button>
             </div>
             <div class="overflow-y-auto border rounded flex-1">
               <table class="w-full text-left text-sm relative">
                 <thead class="bg-slate-100 sticky top-0 z-10 shadow-sm">
                   <tr><th class="p-3 w-16 text-center">Roster #</th><th class="p-3">Name</th><th class="p-3 w-20">Action</th></tr>
                 </thead>
                 <tbody>
                   <tr v-for="stu in currentStudents" :key="stu.StudentID" class="border-b">
                     <td class="p-3 font-bold text-slate-500 text-center">{{ stu.RosterNumber }}</td>
                     <td class="p-3">{{ stu.StudentName }}</td>
                     <td class="p-3"><button @click="deleteStudent(stu.StudentID)" class="text-red-400 hover:underline">Remove</button></td>
                   </tr>
                 </tbody>
               </table>
             </div>
          </div>
          <div v-else class="flex-1 flex items-center justify-center text-slate-400">Select a section to manage students</div>
        </div>
      </div>

      <!-- QUIZZES TAB -->
      <div v-show="activeTab === 'quizzes'" class="flex flex-col md:flex-row gap-6 h-full print:hidden">
        
        <!-- Quizzes Panel -->
        <div class="w-full md:w-1/3 bg-white p-6 rounded-xl shadow border border-slate-200 h-full overflow-y-auto flex flex-col">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold">Quizzes</h2>
            <button v-if="quizQueue.length > 0" @click="saveQuizzes" :disabled="isSavingQuizzes" class="bg-green-600 text-white px-3 py-1 rounded text-sm font-bold shadow hover:bg-green-700 disabled:opacity-50 animate-pulse transition">
              {{ isSavingQuizzes ? 'Saving...' : 'üíæ Save Quizzes' }}
            </button>
          </div>
          <div class="flex gap-2 mb-6">
            <input v-model="newQuizName" @keyup.enter="addQuiz" type="text" placeholder="Quiz Name" class="flex-1 border rounded px-3 outline-none focus:ring-2 focus:ring-blue-500">
            <button @click="addQuiz" class="bg-blue-600 text-white px-4 py-2 rounded font-bold hover:bg-blue-700">+</button>
          </div>
          <ul class="space-y-2 flex-1">
            <li v-for="q in quizzes" :key="q.QuizID" @click="selectedQuiz = q.QuizID" :class="['flex justify-between p-3 rounded cursor-pointer border transition', selectedQuiz === q.QuizID ? 'bg-blue-50 border-blue-200' : 'hover:bg-slate-50 border-transparent']">
              <span>{{ q.QuizName }}</span>
              <button @click.stop="deleteQuiz(q.QuizID)" class="text-red-400 hover:text-red-600">Del</button>
            </li>
          </ul>
        </div>

        <!-- Answer Key Panel -->
        <div class="w-full md:w-2/3 bg-white p-6 rounded-xl shadow border flex flex-col h-full">
          <div v-if="selectedQuizData" class="flex flex-col h-full">
            <div class="flex justify-between items-center mb-6">
              <h2 class="text-xl font-bold">{{ selectedQuizData.QuizName }} - Answer Key</h2>
              <div class="flex gap-2">
                <button v-if="hasUnsavedKey" @click="saveQuizKey" :disabled="isSavingKey" class="bg-green-600 text-white px-4 py-2 rounded text-sm font-bold shadow hover:bg-green-700 disabled:opacity-50 animate-pulse transition">
                  {{ isSavingKey ? 'Saving...' : 'üíæ Save Key' }}
                </button>
                <button @click="addQuestion" class="bg-blue-100 text-blue-700 px-4 py-2 rounded text-sm font-bold hover:bg-blue-200 transition">+ Question</button>
              </div>
            </div>
            <div class="flex-1 overflow-y-auto space-y-3">
              <div v-for="(q, idx) in selectedQuizData.Questions" :key="q.id" class="flex items-center gap-4 bg-slate-50 p-4 rounded border">
                <span class="font-bold w-8 text-slate-400">{{ idx + 1 }}.</span>
                <input v-model="q.text" @change="markKeyUnsaved" class="flex-1 border p-2 rounded outline-none focus:ring-2 focus:ring-blue-400" placeholder="Optional descriptor...">
                <select v-model="q.answer" @change="markKeyUnsaved" class="border p-2 rounded font-bold text-blue-600 bg-white outline-none focus:ring-2 focus:ring-blue-400">
                  <option>A</option><option>B</option><option>C</option><option>D</option>
                </select>
                <button @click="removeQuestion(idx)" class="text-red-400 font-bold hover:text-red-600 px-2">X</button>
              </div>
              <div v-if="selectedQuizData.Questions.length === 0" class="text-center text-slate-400 mt-10">Add questions to build your answer key.</div>
            </div>
          </div>
          <div v-else class="flex-1 flex items-center justify-center text-slate-400">Select a quiz to edit its answer key</div>
        </div>
      </div>

      <!-- SCANNER TAB -->
      <div v-show="activeTab === 'scanner'" class="h-full flex flex-col print:hidden">
        <div v-if="!activeSessionId" class="max-w-xl mx-auto mt-10 bg-white p-8 rounded-xl shadow border">
          <h2 class="text-2xl font-bold mb-6">Launch Scanner</h2>
          
          <div class="space-y-4">
            <!-- Camera Warning -->
            <div v-if="cameraBlocked" class="p-5 bg-amber-50 text-amber-900 border border-amber-300 rounded-lg shadow-sm mb-6">
               <h3 class="font-bold text-lg text-amber-800 mb-2">üì∏ Camera Permission Denied</h3>
               <p class="text-sm">Your browser blocked camera access. Please click the camera icon in your URL bar to allow access, then refresh the page.</p>
            </div>

            <div>
              <label class="block text-sm font-bold mb-2">Select Section</label>
              <select v-model="scanClass" class="w-full border p-3 rounded outline-none focus:ring-2 focus:ring-blue-500">
                <option value="">-- Choose Section --</option>
                <option v-for="c in classes" :value="c.ClassID">{{ c.ClassName }}</option>
              </select>
            </div>
            
            <div>
              <label class="block text-sm font-bold mb-2 mt-4">Select Quiz</label>
              <select v-model="scanQuiz" class="w-full border p-3 rounded outline-none focus:ring-2 focus:ring-blue-500">
                <option value="">-- Choose Quiz --</option>
                <option v-for="q in quizzes" :value="q.QuizID">{{ q.QuizName }}</option>
              </select>
            </div>

            <button @click="startSession" :disabled="!scanClass || !scanQuiz" class="w-full bg-blue-600 text-white py-4 rounded font-bold disabled:opacity-50 transition shadow mt-6">Start Live Projection</button>
          </div>
        </div>

        <div v-else class="flex flex-col lg:flex-row gap-6 h-full">
          <!-- Camera Feed -->
          <div class="w-full lg:w-1/2 bg-black rounded-xl overflow-hidden shadow-xl relative flex flex-col border border-slate-700">
            <div class="bg-slate-900 text-white p-4 flex justify-between items-center z-10 border-b border-slate-800">
              <button @click="qIndex = Math.max(0, qIndex-1)" class="bg-slate-700 px-4 py-2 rounded font-bold hover:bg-slate-600 transition">Previous</button>
              <div class="text-center">
                <div class="font-bold">Question {{ qIndex + 1 }}</div>
                <div class="text-sm text-slate-400">Key: <span class="text-green-400 text-lg font-bold ml-1">{{ activeQuestionKey }}</span></div>
              </div>
              <button @click="qIndex = Math.min(activeQuizData.Questions.length-1, qIndex+1)" class="bg-slate-700 px-4 py-2 rounded font-bold hover:bg-slate-600 transition">Next</button>
            </div>
            
            <div class="flex-1 relative bg-black flex items-center justify-center min-h-[300px] md:min-h-[400px]">
               <video ref="video" class="absolute inset-0 w-full h-full object-cover opacity-0 z-0" playsinline muted></video>
               <canvas ref="canvas" class="absolute inset-0 w-full h-full object-cover z-10"></canvas>
            </div>

            <div class="bg-slate-900 p-4 z-10 text-center border-t border-slate-800">
               <button @click="endSession" class="bg-red-600 text-white px-8 py-3 rounded font-bold hover:bg-red-700 transition w-full md:w-auto shadow">Stop & Exit</button>
            </div>
          </div>

          <!-- Live Projection Box -->
          <div class="w-full lg:w-1/2 bg-white rounded-xl shadow-md border flex flex-col overflow-hidden">
            <div class="bg-slate-800 text-white p-4 font-bold flex justify-between items-center">
              <span>Live Projection</span>
              <span class="text-sm bg-slate-700 px-3 py-1 rounded">Question {{ qIndex + 1 }} / {{ activeQuizData.Questions.length }}</span>
            </div>
            <div class="flex-1 p-4 overflow-y-auto bg-slate-50 grid grid-cols-2 md:grid-cols-3 gap-3 content-start">
               <div v-for="s in currentScanStudents" :key="s.StudentID" 
                    :class="['p-3 rounded-lg border flex justify-between items-center transition-all duration-300',
                      getStudentResult(s.StudentID) === null ? 'bg-white border-slate-200 text-slate-500' :
                      getStudentResult(s.StudentID).isCorrect ? 'bg-green-100 border-green-500 text-green-800 font-bold shadow-sm' :
                      'bg-red-100 border-red-500 text-red-800 font-bold shadow-sm'
                    ]">
                 <span class="truncate pr-2">{{ s.RosterNumber }}. {{ s.StudentName.split(' ')[0] }}</span>
                 <span v-if="getStudentResult(s.StudentID)" class="bg-white px-2 py-0.5 rounded border text-sm">{{ getStudentResult(s.StudentID).answer }}</span>
               </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ANALYTICS TAB -->
      <div v-show="activeTab === 'analytics'" class="h-full flex flex-col print:hidden">
        <div class="bg-white p-6 rounded-xl shadow border mb-6">
          <h2 class="text-xl font-bold mb-4">Analytics</h2>
          <select v-model="analyticsSession" class="w-full md:w-1/2 border p-3 rounded focus:ring-2 focus:ring-blue-500 outline-none">
             <option value="">-- Choose Completed Session --</option>
             <option v-for="sess in uniqueSessions" :value="sess.SessionID">{{ sess.DateStr }} - {{ getClassName(sess.ClassID) }} - {{ getQuizName(sess.QuizID) }}</option>
          </select>
        </div>

        <div v-if="analyticsStats" class="flex-1 overflow-y-auto space-y-6 pb-10">
           <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
             <div class="bg-white p-6 rounded-xl border text-center shadow-sm">
               <div class="text-slate-500 font-medium mb-1">Mean Score</div>
               <div class="text-4xl font-bold text-slate-800">{{ analyticsStats.mean }}</div>
             </div>
             <div class="bg-white p-6 rounded-xl border text-center shadow-sm">
               <div class="text-slate-500 font-medium mb-1">Standard Deviation</div>
               <div class="text-4xl font-bold text-slate-800">{{ analyticsStats.sd }}</div>
             </div>
             <div class="bg-white p-6 rounded-xl border text-center shadow-sm">
               <div class="text-slate-500 font-medium mb-1">Participation</div>
               <div class="text-4xl font-bold text-slate-800">{{ analyticsStats.scores.length }} <span class="text-sm font-normal text-slate-400">students</span></div>
             </div>
           </div>

           <div class="bg-white p-6 rounded-xl border shadow-sm">
             <h3 class="font-bold text-lg mb-4">Item Analysis</h3>
             <div class="overflow-x-auto">
               <table class="w-full text-left text-sm">
                 <thead class="bg-slate-100">
                   <tr><th class="p-3 w-16">Q#</th><th class="p-3 w-16">Key</th><th class="p-3">Correct %</th><th class="p-3 text-center">A%</th><th class="p-3 text-center">B%</th><th class="p-3 text-center">C%</th><th class="p-3 text-center">D%</th></tr>
                 </thead>
                 <tbody>
                   <tr v-for="(item, i) in analyticsStats.itemAnalysis" class="border-b hover:bg-slate-50 transition">
                     <td class="p-3 font-bold text-slate-600">{{ i + 1 }}</td>
                     <td class="p-3 text-green-600 font-bold">{{ item.key }}</td>
                     <td class="p-3 font-bold">
                       <div class="flex items-center gap-2">
                         <div class="w-24 h-2 bg-slate-200 rounded-full overflow-hidden">
                           <div :class="['h-full', item.diff > 70 ? 'bg-green-500' : item.diff > 30 ? 'bg-yellow-500' : 'bg-red-500']" :style="'width:' + item.diff + '%'"></div>
                         </div>
                         <span>{{ item.diff }}%</span>
                       </div>
                     </td>
                     <td class="p-3 text-slate-500 text-center">{{ item.A }}%</td>
                     <td class="p-3 text-slate-500 text-center">{{ item.B }}%</td>
                     <td class="p-3 text-slate-500 text-center">{{ item.C }}%</td>
                     <td class="p-3 text-slate-500 text-center">{{ item.D }}%</td>
                   </tr>
                 </tbody>
               </table>
             </div>
           </div>
        </div>
      </div>
      
    </div> <!-- End Main Content -->

    <!-- Hidden Print Container -->
    <div id="print-area" class="hidden">
      <div v-for="s in currentStudents" :key="s.StudentID" class="qr-card">
         <div class="absolute top-4 left-4 text-xs text-slate-500">Section: {{ getClassName(s.ClassID) }}</div>
         <div class="qr-wrapper">
           <span class="letter letter-A">A</span>
           <span class="letter letter-B">B</span>
           <span class="letter letter-C">C</span>
           <span class="letter letter-D">D</span>
           <img :src="'https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=' + encodeURIComponent(s.StudentID) + '&margin=0'" class="qr-image" crossorigin="anonymous"/>
         </div>
         <div class="absolute bottom-6 right-6 text-right">
           <div class="font-bold text-3xl">#{{ s.RosterNumber }}</div>
           <div class="text-xl font-medium mt-1">{{ s.StudentName }}</div>
         </div>
      </div>
    </div>

  </div>

  <script>
    const { createApp, ref, computed, onMounted } = Vue;

    createApp({
      setup() {
        
        // üëá PASTE YOUR GOOGLE APPS SCRIPT URL HERE üëá
        // Example: const HARDCODED_URL = "https://script.google.com/macros/s/AKfycbxyz.../exec";
        const HARDCODED_URL = "https://script.google.com/macros/s/AKfycbyqNakxad-wAgL4L81qQzDDRg6C2DW9nCZ2p8aFCvi2TulE6q5Uj5JSuNGuW_6jknjxjw/exec"; 
        // üëÜ ---------------------------------------- üëÜ

        // Core App & Auth State
        const gasUrl = ref(HARDCODED_URL);
        
        const isLoggedIn = ref(false);
        const authMode = ref('login'); // 'login' or 'register'
        const authUser = ref(localStorage.getItem('ScanMaster_User') || '');
        const authPass = ref(localStorage.getItem('ScanMaster_Pass') || '');
        const authError = ref('');

        const isLoading = ref(false);
        const activeTab = ref('classes');
        
        // Data Arrays from GAS
        const classes = ref([]);
        const students = ref([]);
        const quizzes = ref([]);
        const results = ref([]); // historical scans
        const localScans = ref([]); // un-synced queue
        
        // Save Queues for Explicit Saving
        const classQueue = ref([]);
        const isSavingClasses = ref(false);

        const studentQueue = ref([]);
        const isSavingStudents = ref(false);

        const quizQueue = ref([]);
        const isSavingQuizzes = ref(false);

        const unsavedKeysMap = ref({});
        const isSavingKey = ref(false);

        // UI States
        const newClassName = ref('');
        const selectedClass = ref('');
        const newStudentName = ref('');
        const newQuizName = ref('');
        const selectedQuiz = ref('');
        const cameraBlocked = ref(false);

        // API Helper for Fetching
        const apiCall = async (action, payload = null) => {
          if (!gasUrl.value) return null;
          try {
            const res = await fetch(gasUrl.value, {
              method: 'POST',
              headers: { 'Content-Type': 'text/plain;charset=utf-8' },
              body: JSON.stringify({ 
                 action, 
                 username: authUser.value,
                 password: authPass.value,
                 payload 
              }),
              redirect: 'follow'
            });
            const textData = await res.text();
            if (textData.trim().startsWith('<')) {
              console.warn("API Call Blocked: Deployed with wrong permissions.");
              return { error: "Permission Error: Google blocked the connection. Deploy script with: Execute as: Me, Who has access: Anyone." };
            }
            return JSON.parse(textData);
          } catch(e) {
            console.error('API Error:', e);
            return { error: "Network Error: Could not connect to Google Server." };
          }
        };

        const authenticate = async () => {
           if (!gasUrl.value || gasUrl.value === "") {
              authError.value = "System Error: The developer has not set the Database URL in the code.";
              return;
           }
           if (!authUser.value || !authPass.value) {
              authError.value = "Username and password required.";
              return;
           }
           authError.value = "";
           isLoading.value = true;
           
           const res = await apiCall('authenticate', { mode: authMode.value });
           
           if (res && res.status === 'success') {
              isLoggedIn.value = true;
              localStorage.setItem('ScanMaster_User', authUser.value);
              localStorage.setItem('ScanMaster_Pass', authPass.value);
              loadDatabase(); // Pull data for just this user
           } else {
              authError.value = res?.error || "Authentication failed.";
              isLoading.value = false;
           }
        };

        const toggleAuthMode = () => {
           authMode.value = authMode.value === 'login' ? 'register' : 'login';
           authError.value = '';
        };

        const logout = () => {
           isLoggedIn.value = false;
           localStorage.removeItem('ScanMaster_User');
           localStorage.removeItem('ScanMaster_Pass');
           authPass.value = '';
           classes.value = [];
           students.value = [];
           quizzes.value = [];
           results.value = [];
           
           // Clear queues on logout so un-saved data gets wiped out
           classQueue.value = [];
           studentQueue.value = [];
           quizQueue.value = [];
           unsavedKeysMap.value = {};
        };

        const loadDatabase = async () => {
          if (!gasUrl.value || !isLoggedIn.value) return;
          isLoading.value = true;
          try {
            // Securely POSTs for data belonging ONLY to this user
            const data = await apiCall('getData');
            
            if (data && data.error) throw new Error(data.error);
            if (!data) throw new Error("Failed to load data.");
            
            classes.value = data.classes || [];
            students.value = data.students || [];
            quizzes.value = data.quizzes || [];
            results.value = data.results || [];
            
            // Start background sync loop for live scans
            setInterval(async () => {
              if (localScans.value.length > 0) {
                 const batch = [...localScans.value];
                 localScans.value = [];
                 await apiCall('recordScans', { scans: batch });
                 results.value.push(...batch); // Optimistic local update
              }
            }, 3000);

          } catch(e) {
            console.error(e);
            alert("Database Sync Error:\n\n" + e.message);
            logout(); // Kick back to login screen on error
          }
          isLoading.value = false;
        };

        onMounted(() => {
          if (gasUrl.value && authUser.value && authPass.value) {
             authenticate();
          }
        });

        // --- CLASSES & SECTIONS ---
        const addClass = () => {
          if (!newClassName.value.trim()) return;
          const id = crypto.randomUUID();
          classes.value.push({ ClassID: id, ClassName: newClassName.value });
          classQueue.value.push({ subAction: 'addClass', data: { id, name: newClassName.value } });
          newClassName.value = '';
        };

        const deleteClass = (id) => {
          classes.value = classes.value.filter(c => c.ClassID !== id);
          students.value = students.value.filter(s => s.ClassID !== id);
          if (selectedClass.value === id) selectedClass.value = '';
          classQueue.value.push({ subAction: 'deleteClass', data: { id } });
        };

        const saveClasses = async () => {
          if(classQueue.value.length === 0) return;
          isSavingClasses.value = true;
          let successCount = 0;
          for (let action of classQueue.value) {
            const res = await apiCall('modifyDB', action);
            if (res && res.status === 'success') successCount++;
            else { alert("Error saving. Check internet connection."); break; }
          }
          classQueue.value = classQueue.value.slice(successCount);
          isSavingClasses.value = false;
        };

        // --- STUDENTS ---
        const currentStudents = computed(() => {
          return students.value.filter(s => s.ClassID === selectedClass.value).sort((a,b)=>a.RosterNumber - b.RosterNumber);
        });

        const addStudent = () => {
          if (!newStudentName.value.trim() || !selectedClass.value) return;
          const roster = currentStudents.value.length + 1;
          const id = crypto.randomUUID();
          students.value.push({ StudentID: id, ClassID: selectedClass.value, RosterNumber: roster, StudentName: newStudentName.value });
          studentQueue.value.push({ subAction: 'addStudent', data: { id, classId: selectedClass.value, roster, name: newStudentName.value } });
          newStudentName.value = '';
        };

        const deleteStudent = (id) => {
          students.value = students.value.filter(s => s.StudentID !== id);
          studentQueue.value.push({ subAction: 'deleteStudent', data: { id } });
        };

        const saveStudents = async () => {
          if(studentQueue.value.length === 0) return;
          isSavingStudents.value = true;
          let successCount = 0;
          for (let action of studentQueue.value) {
            const res = await apiCall('modifyDB', action);
            if (res && res.status === 'success') successCount++;
            else { alert("Error saving. Check internet connection."); break; }
          }
          studentQueue.value = studentQueue.value.slice(successCount);
          isSavingStudents.value = false;
        };

        const printQRs = () => { window.print(); };
        const getClassName = (id) => classes.value.find(c => c.ClassID === id)?.ClassName || 'Unknown';
        const getQuizName = (id) => quizzes.value.find(q => q.QuizID === id)?.QuizName || 'Unknown';

        // --- QUIZZES ---
        const addQuiz = () => {
          if(!newQuizName.value.trim()) return;
          const id = crypto.randomUUID();
          quizzes.value.push({ QuizID: id, QuizName: newQuizName.value, Questions: [] });
          quizQueue.value.push({ subAction: 'saveQuiz', data: { id, name: newQuizName.value, questions: [] } });
          newQuizName.value = '';
        };

        const deleteQuiz = (id) => {
          quizzes.value = quizzes.value.filter(q => q.QuizID !== id);
          if(selectedQuiz.value === id) selectedQuiz.value = '';
          quizQueue.value.push({ subAction: 'deleteQuiz', data: { id } });
        };

        const saveQuizzes = async () => {
          if(quizQueue.value.length === 0) return;
          isSavingQuizzes.value = true;
          let successCount = 0;
          for (let action of quizQueue.value) {
            const res = await apiCall('modifyDB', action);
            if (res && res.status === 'success') successCount++;
            else { alert("Error saving. Check internet connection."); break; }
          }
          quizQueue.value = quizQueue.value.slice(successCount);
          isSavingQuizzes.value = false;
        };

        // --- ANSWER KEYS ---
        const selectedQuizData = computed(() => quizzes.value.find(q => q.QuizID === selectedQuiz.value));
        const hasUnsavedKey = computed(() => selectedQuizData.value && unsavedKeysMap.value[selectedQuizData.value.QuizID]);

        const markKeyUnsaved = () => {
          if(selectedQuizData.value) {
            unsavedKeysMap.value[selectedQuizData.value.QuizID] = true;
          }
        };

        const saveQuizKey = async () => {
          if(!selectedQuizData.value) return;
          isSavingKey.value = true;
          const res = await apiCall('modifyDB', { 
            subAction: 'updateQuiz', 
            data: { id: selectedQuizData.value.QuizID, name: selectedQuizData.value.QuizName, questions: selectedQuizData.value.Questions } 
          });
          if (res && res.status === 'success') {
             unsavedKeysMap.value[selectedQuizData.value.QuizID] = false;
          } else {
             alert("Error saving answer key. Check internet connection.");
          }
          isSavingKey.value = false;
        };

        const addQuestion = () => {
          if(!selectedQuizData.value) return;
          selectedQuizData.value.Questions.push({ id: crypto.randomUUID(), text: ``, answer: 'A' });
          markKeyUnsaved();
        };

        const removeQuestion = (idx) => {
          selectedQuizData.value.Questions.splice(idx, 1);
          markKeyUnsaved();
        };

        // --- SCANNER ---
        const scanClass = ref('');
        const scanQuiz = ref('');
        const activeSessionId = ref('');
        const qIndex = ref(0);
        const video = ref(null);
        const canvas = ref(null);
        let stream = null;
        let scanRaf = null;
        const lastScanMap = {};

        const activeQuizData = computed(() => quizzes.value.find(q => q.QuizID === scanQuiz.value));
        const activeQuestionKey = computed(() => activeQuizData.value?.Questions[qIndex.value]?.answer);
        const currentScanStudents = computed(() => students.value.filter(s => s.ClassID === scanClass.value).sort((a,b)=>a.RosterNumber - b.RosterNumber));
        
        const liveSessionResults = ref([]); // reactive UI updates for current session

        const getStudentResult = (studentId) => {
          const res = liveSessionResults.value.find(r => r.studentId === studentId && r.qNum === (qIndex.value+1));
          return res || null;
        };

        const startSession = async () => {
           activeSessionId.value = crypto.randomUUID();
           qIndex.value = 0;
           liveSessionResults.value = [];
           cameraBlocked.value = false;
           try {
             if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
               throw new Error("Your browser does not support camera access or you are not on a secure (HTTPS) connection.");
             }
             
             try {
               stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
             } catch (err) {
               if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') throw err;
               stream = await navigator.mediaDevices.getUserMedia({ video: true });
             }

             video.value.srcObject = stream;
             video.value.setAttribute("playsinline", true);
             await video.value.play();
             scanRaf = requestAnimationFrame(tick);

           } catch(e) { 
             console.error("Camera Setup Failed:", e);
             if (e.name === 'NotAllowedError' || e.name === 'PermissionDeniedError') {
               cameraBlocked.value = true;
             } else {
               alert("Camera Error: " + e.message);
             }
             activeSessionId.value = '';
           }
        };

        const endSession = () => {
           if(stream) stream.getTracks().forEach(t => t.stop());
           cancelAnimationFrame(scanRaf);
           activeSessionId.value = '';
        };

        const tick = () => {
           if (!video.value || !canvas.value || !activeSessionId.value) return;
           if (video.value.readyState === video.value.HAVE_ENOUGH_DATA) {
              const ctx = canvas.value.getContext('2d');
              canvas.value.height = video.value.videoHeight;
              canvas.value.width = video.value.videoWidth;
              ctx.drawImage(video.value, 0, 0, canvas.value.width, canvas.value.height);
              
              const imgData = ctx.getImageData(0,0, canvas.value.width, canvas.value.height);
              const code = jsQR(imgData.data, imgData.width, imgData.height, { inversionAttempts: "dontInvert" });
              
              if(code) {
                 ctx.beginPath();
                 ctx.moveTo(code.location.topLeftCorner.x, code.location.topLeftCorner.y);
                 ctx.lineTo(code.location.topRightCorner.x, code.location.topRightCorner.y);
                 ctx.lineTo(code.location.bottomRightCorner.x, code.location.bottomRightCorner.y);
                 ctx.lineTo(code.location.bottomLeftCorner.x, code.location.bottomLeftCorner.y);
                 ctx.closePath();
                 ctx.lineWidth = 4;
                 ctx.strokeStyle = '#22c55e';
                 ctx.stroke();

                 const studentId = code.data;
                 const now = Date.now();
                 
                 // Debounce 1.5s
                 if (!lastScanMap[studentId] || now - lastScanMap[studentId] > 1500) {
                    if (currentScanStudents.value.some(s => s.StudentID === studentId)) {
                        const dx = code.location.topLeftCorner.x - code.location.bottomLeftCorner.x;
                        const dy = code.location.topLeftCorner.y - code.location.bottomLeftCorner.y;
                        const angle = Math.atan2(dy, dx) * (180 / Math.PI);
                        
                        let ans = 'D';
                        if (angle > -135 && angle <= -45) ans = 'A';
                        else if (angle > -45 && angle <= 45) ans = 'B';
                        else if (angle > 45 && angle <= 135) ans = 'C';

                        const isCorrect = (ans === activeQuestionKey.value);
                        
                        const payload = {
                           sessionId: activeSessionId.value, classId: scanClass.value, quizId: scanQuiz.value,
                           studentId: studentId, qNum: qIndex.value + 1, answer: ans, isCorrect: isCorrect
                        };

                        liveSessionResults.value = liveSessionResults.value.filter(r => !(r.studentId === studentId && r.qNum === (qIndex.value+1)));
                        liveSessionResults.value.push(payload);
                        localScans.value.push(payload);
                        lastScanMap[studentId] = now;
                    }
                 }
              }
           }
           if (activeSessionId.value) scanRaf = requestAnimationFrame(tick);
        };

        // --- ANALYTICS ---
        const analyticsSession = ref('');
        const uniqueSessions = computed(() => {
           const map = {};
           results.value.forEach(r => {
             if(!map[r.SessionID]) {
                 map[r.SessionID] = { SessionID: r.SessionID, ClassID: r.ClassID, QuizID: r.QuizID, DateStr: new Date(r.Timestamp).toLocaleDateString() };
             }
           });
           return Object.values(map);
        });

        const analyticsStats = computed(() => {
           if(!analyticsSession.value) return null;
           const sResults = results.value.filter(r => r.SessionID === analyticsSession.value);
           if(sResults.length === 0) return null;
           
           const sessMeta = uniqueSessions.value.find(s => s.SessionID === analyticsSession.value);
           const quizMeta = quizzes.value.find(q => q.QuizID === sessMeta.QuizID);
           if(!quizMeta) return null;

           const studentScores = {};
           sResults.forEach(r => {
             if(!studentScores[r.StudentID]) studentScores[r.StudentID] = 0;
             if(r.IsCorrect) studentScores[r.StudentID]++;
           });
           
           const scoresArr = Object.values(studentScores);
           const mean = scoresArr.reduce((a,b)=>a+b, 0) / Math.max(scoresArr.length, 1);
           const variance = scoresArr.reduce((a,b)=>a+Math.pow(b-mean, 2), 0) / Math.max(scoresArr.length, 1);

           const itemAnalysis = quizMeta.Questions.map((q, i) => {
              const qNum = i + 1;
              const qAns = sResults.filter(r => r.QuestionNum === qNum);
              const total = Math.max(qAns.length, 1);
              const count = (ans) => qAns.filter(r => r.Answer === ans).length;
              return {
                 key: q.answer,
                 diff: Math.round((qAns.filter(r=>r.IsCorrect).length / total) * 100),
                 A: Math.round((count('A')/total)*100),
                 B: Math.round((count('B')/total)*100),
                 C: Math.round((count('C')/total)*100),
                 D: Math.round((count('D')/total)*100),
              };
           });

           return { mean: mean.toFixed(2), sd: Math.sqrt(variance).toFixed(2), scores: scoresArr, itemAnalysis };
        });

        return {
          gasUrl, isLoggedIn, authMode, authUser, authPass, authError, authenticate, toggleAuthMode, logout,
          isLoading, activeTab, classes, students, quizzes,
          newClassName, selectedClass, addClass, deleteClass, currentStudents,
          newStudentName, addStudent, deleteStudent, getClassName, printQRs,
          newQuizName, selectedQuiz, addQuiz, deleteQuiz, selectedQuizData, addQuestion, removeQuestion,
          scanClass, scanQuiz, activeSessionId, qIndex, startSession, endSession, activeQuizData, activeQuestionKey, currentScanStudents, getStudentResult,
          video, canvas,
          analyticsSession, uniqueSessions, getQuizName, analyticsStats,
          cameraBlocked,
          
          classQueue, isSavingClasses, saveClasses,
          studentQueue, isSavingStudents, saveStudents,
          quizQueue, isSavingQuizzes, saveQuizzes,
          hasUnsavedKey, isSavingKey, saveQuizKey, markKeyUnsaved
        };
      }
    }).mount('#app');
  </script>
  
  <script>
    // PWA Service Worker Registration
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js').then(() => {
          console.log('PWA ServiceWorker registered successfully.');
        }).catch(err => {
          console.warn('PWA ServiceWorker registration failed.', err);
        });
      });
    }
  </script>
</body>
</html>
